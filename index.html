<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Clone</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <style>
        :root { /* ... Variables CSS inchangées ... */ }
        [data-theme="light"] { /* ... Thème clair inchangé ... */ }
        [data-theme="dark"] {
            --bg-color: #212121; --text-primary: #ececf1; --text-secondary: #9ca3af;
            --border-color: #3a3a3a; --sidebar-bg: #171717; --sidebar-hover: #2d2d2d;
            --chat-bg: #212121; --user-msg-text: #ececf1; --bot-msg-bg: #212121;
            --input-bg: #212121; --input-border: #555; --button-bg: #3c3c3c;
            --button-text: #ececf1; --button-hover: #4d4d4d; --menu-bg: #2d2d2d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--bg-color); color: var(--text-primary); display: flex; height: 100vh; }
        .sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 8px; transition: left 0.3s ease; }
        .sidebar-header { display: flex; align-items: center; padding: 8px; margin-bottom: 16px; }
        .new-chat-btn { flex-grow: 1; padding: 12px; background: var(--sidebar-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease; }
        .new-chat-btn:hover { background: var(--sidebar-hover); }
        .sidebar-menu { flex: 1; overflow-y: auto; position: relative; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background-color 0.2s ease; position: relative; }
        .menu-item:hover, .menu-item.active { background: var(--sidebar-hover); }
        .conversations-header { padding: 16px 16px 8px; font-size: 12px; font-weight: 500; color: var(--text-secondary); }
        .sidebar-footer { padding: 8px; border-top: 1px solid var(--border-color); position: relative; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; position: relative; }
        .header-controls { display: flex; align-items: center; gap: 8px; }
        .header-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 8px; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .header-btn:hover { background: var(--sidebar-hover); color: var(--text-primary); }
        .hamburger { display: none; /* ... */ }
        .model-info { font-size: 18px; }
        .chat-container { flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        .messages-wrapper { max-width: 800px; width: 100%; margin: 0 auto; padding: 24px; }
        .welcome-screen { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 24px; margin-bottom: 15vh; }
        .welcome-title { font-size: 2.25rem; font-weight: 600; color: var(--text-secondary); }
        .message-group { margin-bottom: 24px; }
        .message { display: flex; gap: 16px; }
        .user-message .message-content { font-weight: 600; text-align: right; }
        .bot-message { align-items: flex-start; }
        .message-avatar { /* ... */ }
        .message-content { flex: 1; line-height: 1.7; font-size: 16px; padding-top: 4px; }
        .message-content p, .message-content ul, .message-content ol, .message-content h1, .message-content h2, .message-content h3 { margin-bottom: 1rem; }
        .input-area { padding: 16px 24px 24px; }
        .input-container { max-width: 800px; margin: 0 auto; }
        .input-wrapper { display: flex; align-items: center; gap: 8px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 12px; padding: 8px 16px; }
        .message-input { flex: 1; border: none; background: none; outline: none; resize: none; font-size: 16px; color: var(--text-primary); max-height: 200px; }
        .send-button { width: 32px; height: 32px; background: var(--button-bg); color: var(--button-text); border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; }
        .send-button:disabled { background: var(--gray-700); cursor: not-allowed; }
        .pulsing-dot { display: inline-block; width: 8px; height: 8px; background-color: var(--text-primary); border-radius: 50%; animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.5); opacity: 1; } }

        /* --- STYLES POUR LES NOUVEAUX MENUS CONTEXTUELS --- */
        .menu-options-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px; border-radius: 5px; opacity: 0; transition: opacity 0.2s ease; }
        .menu-item:hover .menu-options-btn { opacity: 1; }
        .menu-options-btn:hover { background-color: var(--button-bg); }
        .menu {
            display: none; position: absolute; z-index: 1000; background-color: var(--menu-bg);
            border-radius: 8px; padding: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            width: 180px; font-size: 14px;
        }
        .menu.show { display: block; }
        .menu-item-action { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; cursor: pointer; }
        .menu-item-action:hover { background-color: var(--sidebar-hover); }
        .menu-item-action.delete { color: var(--red-500); }
        .menu-divider { height: 1px; background-color: var(--border-color); margin: 8px 0; }
        #user-menu { bottom: calc(100% + 8px); left: 8px; width: 240px; }
        #header-menu { top: calc(100% + 4px); right: 24px; }
    </style>
</head>
<body data-theme="dark">
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="startNewChat()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                <span>New chat</span>
            </button>
        </div>
        <div class="sidebar-menu">
            <div class="conversations-header">Chats</div>
            <div id="conversations"></div>
        </div>
        <!-- MENU UTILISATEUR (PIED DE PAGE) -->
        <div class="sidebar-footer">
            <div class="menu-item" id="user-menu-trigger" onclick="toggleUserMenu()">
                <div class="message-avatar" style="width: 28px; height: 28px;">S</div>
                <span>Stephane Guei</span>
            </div>
            <div class="menu" id="user-menu">
                <div class="menu-item-action"><span>gueistephane4@gmail.com</span></div>
                <div class="menu-divider"></div>
                <div class="menu-item-action"><span>Upgrade plan</span></div>
                <div class="menu-item-action"><span>Customize ChatGPT</span></div>
                <div class="menu-item-action"><span>Settings</span></div>
                <div class="menu-item-action"><span>Help</span></div>
                <div class="menu-divider"></div>
                <div class="menu-item-action"><span>Log out</span></div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="chat-header">
            <button class="hamburger" onclick="toggleSidebar()">☰</button>
            <div class="model-info">ChatGPT</div>
            <!-- MENU D'EN-TÊTE -->
            <div class="header-controls">
                <button class="header-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13"/></svg>
                    <span>Share</span>
                </button>
                <button class="header-btn" id="header-menu-trigger" onclick="toggleHeaderMenu()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/><circle cx="5" cy="12" r="2"/></svg>
                </button>
                <div class="menu" id="header-menu">
                    <div class="menu-item-action"><span>Archive</span></div>
                    <div class="menu-item-action"><span>Report</span></div>
                    <div class="menu-item-action delete"><span>Delete</span></div>
                </div>
            </div>
        </div>
        <div class="chat-container" id="chatContainer">
            <div class="messages-wrapper" id="messagesWrapper">
                 <div class="welcome-screen" id="welcomeScreen">
                    <h1 class="welcome-title">What's on your mind today?</h1>
                </div>
            </div>
        </div>
        <div class="input-area">
             <!-- ... Zone de saisie inchangée ... -->
             <div class="input-container">
                <div class="input-wrapper">
                    <textarea class="message-input" id="messageInput" placeholder="Ask anything..." rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize()"></textarea>
                    <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>
                         <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M13.42,2.44,4.44,6.41a1,1,0,0,0-.44,1.34L6.41,12,4,16.25a1,1,0,0,0,.44,1.34l9,3.95a1,1,0,0,0,1.11-1V3.41A1,1,0,0,0,13.42,2.44Z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Conteneur pour le menu de conversation, qui sera positionné dynamiquement -->
    <div class="menu" id="chat-menu">
        <div class="menu-item-action"><span>Share</span></div>
        <div class="menu-item-action"><span>Rename</span></div>
        <div class="menu-item-action"><span>Archive</span></div>
        <div class="menu-item-action delete"><span>Delete</span></div>
    </div>


    <script>
        // --- Variables globales et configuration ---
        let currentConversationId = null;
        let conversations = {};
        let isLoading = false;
        const config = {
            apiUrl: 'https://srv886023.hstgr.cloud/api/v1/prediction/b02cce0c-77a8-4b4f-8a4a-0de7afd15fc2'
        };

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', () => {
            loadConversations();
            setTheme(localStorage.getItem('theme') || 'dark');
            renderConversation();
            document.getElementById('messageInput').addEventListener('input', () => {
                autoResize();
                document.getElementById('sendButton').disabled = document.getElementById('messageInput').value.trim() === '' || isLoading;
            });

            // GESTIONNAIRE GLOBAL POUR FERMER LES MENUS
            window.addEventListener('click', (event) => {
                closeAllMenus(event);
            });
        });
        
        // --- Fonctions des menus ---
        const toggleUserMenu = () => document.getElementById('user-menu').classList.toggle('show');
        const toggleHeaderMenu = () => document.getElementById('header-menu').classList.toggle('show');

        const toggleChatMenu = (event, convId) => {
            event.stopPropagation(); // Empêche de sélectionner la conv en même temps
            const menu = document.getElementById('chat-menu');
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            
            menu.style.left = `${rect.left}px`;
            menu.style.top = `${rect.bottom + 4}px`;
            menu.classList.toggle('show');
        };

        const closeAllMenus = (event) => {
            // Ne ferme pas si on clique sur un bouton de menu
            if (event.target.closest('#user-menu-trigger, #header-menu-trigger, .menu-options-btn')) {
                return;
            }
            // Ne ferme pas si on clique à l'intérieur d'un menu déjà ouvert
            if (event.target.closest('.menu')) {
                return;
            }
            document.getElementById('user-menu').classList.remove('show');
            document.getElementById('header-menu').classList.remove('show');
            document.getElementById('chat-menu').classList.remove('show');
        };

        // --- Fonctions de base (thème, sidebar, etc.) ---
        const setTheme = (theme) => { document.body.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); };
        const toggleTheme = () => setTheme(document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
        const toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
        
        // --- Fonctions de gestion des conversations ---
        const loadConversations = () => { conversations = JSON.parse(localStorage.getItem('chat-conversations') || '{}'); updateConversationsList(); };
        const saveConversations = () => localStorage.setItem('chat-conversations', JSON.stringify(conversations));

        const startNewChat = () => {
            currentConversationId = `chat_${Date.now()}`;
            conversations[currentConversationId] = { id: currentConversationId, title: 'New Chat', messages: [], createdAt: new Date().toISOString() };
            renderConversation();
            updateConversationsList();
            saveConversations();
            document.getElementById('messageInput').focus();
        };
        const selectConversation = (id) => { currentConversationId = id; renderConversation(); updateConversationsList(); };

        const updateConversationsList = () => {
            const container = document.getElementById('conversations');
            container.innerHTML = '';
            Object.values(conversations)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .forEach(conv => {
                    const item = document.createElement('div');
                    item.className = `menu-item ${conv.id === currentConversationId ? 'active' : ''}`;
                    item.onclick = (e) => { if (!e.target.closest('.menu-options-btn')) selectConversation(conv.id); };
                    
                    item.innerHTML = `
                        <span style="flex-grow: 1;">${conv.title}</span>
                        <button class="menu-options-btn" onclick="toggleChatMenu(event, '${conv.id}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/><circle cx="5" cy="12" r="2"/></svg>
                        </button>
                    `;
                    container.appendChild(item);
                });
        };
        
        // --- Fonctions d'affichage et d'envoi des messages (inchangées) ---
        const renderConversation = () => {
             const wrapper = document.getElementById('messagesWrapper');
            const welcomeScreen = document.getElementById('welcomeScreen');
            wrapper.innerHTML = '';
            if (currentConversationId && conversations[currentConversationId]) {
                welcomeScreen.style.display = 'none';
                conversations[currentConversationId].messages.forEach(msg => addMessageToUI(msg.content, msg.isUser));
            } else {
                wrapper.appendChild(welcomeScreen);
                welcomeScreen.style.display = 'flex';
            }
        };

        const addMessageToUI = (content, isUser) => {
            // ... (Cette fonction est identique à la version précédente)
            document.getElementById('welcomeScreen').style.display = 'none';
            const wrapper = document.getElementById('messagesWrapper');
            const group = document.createElement('div');
            group.className = 'message-group';
            if (isUser) {
                group.innerHTML = `<div class="message user-message"><div class="message-content">${content}</div></div>`;
            } else {
                group.innerHTML = `
                    <div class="message bot-message">
                        <div class="message-avatar">
                             <svg viewBox="0 0 41 41" fill="none"><path d="M37.532 19.2c-1.176 1.76-2.82 3.295-4.464 4.59-1.644 1.3-3.29 2.36-4.933 3.18-.035.018-.07.036-.106.053-1.644.82-3.29 1.3-4.933 1.467-.036.002-.07.003-.106.003-1.644-.165-3.29-.645-4.934-1.467-.035-.017-.07-.035-.106-.053-1.643-.82-3.29-1.88-4.933-3.18-1.643-1.295-3.288-2.83-4.464-4.59-1.177-1.76-1.765-3.52-1.765-5.28s.588-3.52 1.765-5.28c1.176-1.76 2.82-3.295 4.464-4.59 1.644-1.3 3.29-2.36 4.934-3.18.035-.018.07-.036-.106-.053 1.643-.82 3.29-1.3 4.933-1.467.036-.002.07-.003-.106-.003s.07.001.106.003c1.644.166 3.29.646 4.934 1.467.035.017.07.035.106.053 1.643.82 3.29 1.88 4.933 3.18 1.643 1.295 3.288 2.83 4.464 4.59 1.177 1.76.588 3.52.588 5.28s-.588 3.52-1.765 5.28zM20.5 35.26c-1.37-.137-2.74-.54-4.11-1.205-1.37-.665-2.74-1.595-4.11-2.79-1.37-1.19-2.495-2.6-3.38-4.07-1.77-2.945-1.77-6.42 0-9.365.885-1.47 2.01-2.88 3.38-4.07 1.37-1.195 2.74-2.125 4.11-2.79 1.37-.665 2.74-1.07 4.11-1.205 2.945-.27 5.89.815 7.99 2.915 2.1 2.1 3.185 5.045 2.915 7.99-.135 1.37-.54 2.74-1.205 4.11-.665 1.37-1.595 2.74-2.79 4.11-1.19 1.37-2.6 2.495-4.07 3.38-1.47.885-2.88 1.53-4.245 1.935a8.216 8.216 0 0 1-1.765.175z" fill="currentColor"></path></svg>
                        </div>
                        <div class="message-content">${content}</div>
                    </div>`;
            }
            wrapper.appendChild(group);
            scrollToBottom();
            return group.querySelector('.message-content');
        };
        const saveMessage = (content, isUser) => {
            if (!currentConversationId) return;
            const conv = conversations[currentConversationId];
            conv.messages.push({ content, isUser });
            if (conv.messages.length === 1 && isUser) {
                conv.title = content.substring(0, 35) + (content.length > 35 ? '...' : '');
                updateConversationsList();
            }
            saveConversations();
        };
        const sendMessage = async () => { /* ... Identique à la version précédente ... */ 
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message || isLoading) return;

            if (!currentConversationId) startNewChat();
            
            saveMessage(message, true);
            addMessageToUI(message, true);
            input.value = ''; autoResize(); setLoading(true);

            // Phase 1: Afficher l'indicateur de "réflexion"
            const botMessageElement = addMessageToUI('<div class="pulsing-dot"></div>', false);
            let fullResponse = '';

            try {
                // Phase 2: Lancer le streaming
                await streamFlowiseResponse(message, (chunk) => {
                    // À la réception du premier morceau, remplacer le point par le texte
                    if (fullResponse === '') botMessageElement.innerHTML = '';
                    
                    fullResponse += chunk;
                    botMessageElement.innerHTML = marked.parse(fullResponse + ' ▌'); // Ajouter un curseur
                    scrollToBottom();
                });
            } catch (error) {
                botMessageElement.innerHTML = `❌ Erreur: ${error.message}`;
            } finally {
                // Nettoyage final
                botMessageElement.innerHTML = marked.parse(fullResponse); // Retirer le curseur
                saveMessage(fullResponse, false);
                setLoading(false);
            }
        };
        async function streamFlowiseResponse(question, onChunk) { /* ... Identique à la version précédente ... */ 
            const response = await fetch(config.apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ "question": question }),
            });

            if (!response.ok) throw new Error(`Erreur réseau: ${response.status} ${response.statusText}`);
            if (!response.body) throw new Error('La réponse ne supporte pas le streaming.');

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                // Flowise envoie parfois plusieurs 'data:' d'un coup
                const parts = buffer.split('\n');
                buffer = parts.pop(); // Garder le dernier morceau potentiellement incomplet

                for (const part of parts) {
                    if (part.startsWith('data: ')) {
                        try {
                            const jsonData = JSON.parse(part.substring(6));
                            // Le format exact du chunk peut varier, adaptez si nécessaire
                            const chunkContent = jsonData.text || jsonData.token || (typeof jsonData === 'string' ? jsonData : '');
                            if (chunkContent) {
                                onChunk(chunkContent);
                            }
                        } catch (e) {
                            console.error('Erreur de parsing du chunk JSON:', part);
                        }
                    }
                }
            }
        }
        const setLoading = (loading) => { /* ... Identique à la version précédente ... */ 
            isLoading = loading;
            const sendButton = document.getElementById('sendButton');
            document.getElementById('messageInput').disabled = loading;
            sendButton.disabled = loading;
            if (!loading) document.getElementById('messageInput').focus();
        };
        const autoResize = () => { const textarea = document.getElementById('messageInput'); textarea.style.height = 'auto'; textarea.style.height = `${textarea.scrollHeight}px`; };
        const scrollToBottom = () => { const container = document.getElementById('chatContainer'); container.scrollTop = container.scrollHeight; };
        const handleKeyDown = (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } };

    </script>
</body>
</html>
