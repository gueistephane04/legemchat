<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Clone</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --white: #ffffff; --black: #000000; --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-300: #d1d5db; --gray-400: #9ca3af; --gray-500: #6b7280; --gray-600: #4b5563; --gray-700: #374151;
            --gray-800: #1f2937; --gray-900: #111827; --green-500: #10b981; --green-600: #059669; --red-500: #ef4444;
            --red-600: #dc2626; --blue-500: #3b82f6;
        }
        [data-theme="light"] {
            --bg-color: var(--white); --text-primary: var(--gray-800); --text-secondary: var(--gray-600);
            --border-color: var(--gray-200); --sidebar-bg: var(--gray-50); --sidebar-hover: var(--gray-200);
            --chat-bg: var(--white); --user-msg-bg: var(--gray-100); --user-msg-text: var(--gray-800);
            --bot-msg-bg: var(--white); --bot-msg-text: var(--gray-800); --input-bg: var(--white);
            --input-border: var(--gray-300); --button-bg: var(--gray-800); --button-text: var(--white);
            --button-hover: var(--black); --success-color: var(--green-500); --error-color: var(--red-500);
        }
        [data-theme="dark"] {
            --bg-color: #212121; --text-primary: #ececf1; --text-secondary: #9ca3af; --border-color: #3a3a3a;
            --sidebar-bg: #171717; --sidebar-hover: #2d2d2d; --chat-bg: #212121; --user-msg-bg: #2f2f2f;
            --user-msg-text: var(--white); --bot-msg-bg: #212121; --bot-msg-text: #ececf1; --input-bg: #2f2f2f;
            --input-border: #424242; --button-bg: #19c37d; --button-text: var(--white); --button-hover: var(--green-600);
            --success-color: var(--green-500); --error-color: var(--red-500);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--bg-color); color: var(--text-primary); display: flex; height: 100vh; transition: background-color 0.2s ease, color 0.2s ease; }
        .sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; transition: background-color 0.2s ease; padding: 8px; }
        .sidebar-header { display: flex; gap: 8px; align-items: center; padding: 8px; margin-bottom: 16px; }
        .new-chat-btn { flex-grow: 1; padding: 12px; background: var(--sidebar-bg); border: none; border-radius: 8px; color: var(--text-primary); cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease; }
        .new-chat-btn:hover { background: var(--sidebar-hover); }
        .sidebar-menu { flex: 1; overflow-y: auto; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--text-secondary); transition: all 0.2s ease; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .menu-item:hover, .conversation-item:hover { background: var(--sidebar-hover); color: var(--text-primary); }
        .menu-item.active, .conversation-item.active { background: var(--sidebar-hover); color: var(--text-primary); }
        .conversations-header { padding: 16px 16px 8px; font-size: 12px; font-weight: 500; color: var(--text-secondary); text-transform: uppercase; }
        .conversations { padding: 0 8px; }
        .conversation-item { position: relative; padding-right: 30px; }
        .delete-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; opacity: 0; transition: opacity 0.2s ease; padding: 4px; font-size: 16px; border-radius: 4px; }
        .conversation-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: var(--error-color); }
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border-color); }
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--chat-bg); }
        .chat-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; background: var(--chat-bg); }
        .hamburger { display: none; background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-primary); }
        .model-info { font-size: 18px; font-weight: 600; color: var(--text-primary); }
        .header-controls { display: flex; align-items: center; gap: 8px; }
        .theme-toggle { background: none; border: none; cursor: pointer; font-size: 20px; padding: 8px; border-radius: 6px; transition: all 0.2s ease; color: var(--text-primary); }
        .theme-toggle:hover { background: var(--sidebar-hover); }
        .chat-container { flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        .welcome-screen { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 24px; margin-bottom: 10vh; }
        .welcome-logo { width: 50px; height: 50px; background: var(--black); color: var(--white); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 24px; }
        .welcome-logo svg { width: 30px; height: 30px; }
        .welcome-title { font-size: 24px; font-weight: 600; color: var(--text-primary); }
        [data-theme="dark"] .welcome-logo { background: var(--white); color: var(--black); }
        .messages-wrapper { max-width: 800px; width: 100%; margin: 0 auto; padding: 24px; }
        .message-group { margin-bottom: 32px; }
        .message { display: flex; gap: 16px; align-items: flex-start; }
        .message-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; flex-shrink: 0; }
        .user-avatar { background: var(--green-500); color: var(--white); }
        .bot-avatar { background: var(--black); color: var(--white); padding: 5px; }
        [data-theme="dark"] .bot-avatar { background: var(--white); color: var(--black); }
        .bot-avatar svg { width: 100%; height: 100%; }
        .message-content { flex: 1; line-height: 1.7; font-size: 16px; padding-top: 4px; }
        .message-content p { margin-top: 0; margin-bottom: 1rem; }
        .input-area { padding: 16px 24px 24px; background: var(--chat-bg); }
        .input-container { max-width: 800px; margin: 0 auto; position: relative; }
        .input-wrapper { background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 24px; padding: 6px; display: flex; align-items: flex-end; gap: 8px; transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .input-wrapper:focus-within { border-color: var(--gray-500); }
        .message-input { flex: 1; border: none; background: none; outline: none; resize: none; font-size: 16px; line-height: 1.5; color: var(--text-primary); max-height: 200px; min-height: 24px; font-family: inherit; padding: 10px 0; }
        .message-input::placeholder { color: var(--text-secondary); }
        .send-button { width: 32px; height: 32px; background: var(--button-bg); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; margin: 4px; }
        .send-button:hover:not(:disabled) { background: var(--button-hover); }
        .send-button:disabled { background: var(--gray-300); cursor: not-allowed; }
        .send-button svg { width: 16px; height: 16px; fill: var(--button-text); }
        [data-theme="dark"] .send-button:disabled { background: var(--gray-600); }
        .loading{display:inline-block;width:20px;height:20px;border:2px solid var(--border-color);border-radius:50%;border-top-color:var(--button-bg);animation:spin 1s ease-in-out infinite}@keyframes spin{to{transform:rotate(360deg)}}
        
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: var(--text-primary);
            animation: blink 1s infinite;
            margin-left: 2px;
            vertical-align: middle;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .streaming-message {
            position: relative;
        }
        
        @media (max-width: 768px) { 
            .sidebar { position: fixed; left: -260px; top: 0; height: 100%; z-index: 100; transition: left 0.3s ease; } 
            .sidebar.open { left: 0; box-shadow: 0 0 40px rgba(0,0,0,0.2); } 
            .main-content { width: 100%; } 
            .hamburger { display: block; } 
            .messages-wrapper, .input-area { padding: 16px; } 
        }
    </style>
</head>
<body data-theme="dark">
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="startNewChat()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                <span>New chat</span>
            </button>
        </div>
        <div class="sidebar-menu">
            <div class="conversations-header">Chats</div>
            <div class="conversations" id="conversations"></div>
        </div>
        <div class="sidebar-footer">
            <div class="menu-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                <span>Stephane Guei</span>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="chat-header">
            <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
            <div class="model-info">ChatGPT</div>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()" title="Changer le th√®me">üåô</button>
            </div>
        </div>
        <div class="chat-container" id="chatContainer">
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-logo">
                    <svg viewBox="0 0 41 41"><path fill="currentColor" d="M37.532 19.2c-1.176 1.76-2.82 3.295-4.464 4.59-1.644 1.3-3.29 2.36-4.933 3.18-.035.018-.07.036-.106.053-1.644.82-3.29 1.3-4.933 1.467-.036.002-.07.003-.106.003-1.644-.165-3.29-.645-4.934-1.467-.035-.017-.07-.035-.106-.053-1.643-.82-3.29-1.88-4.933-3.18-1.643-1.295-3.288-2.83-4.464-4.59-1.177-1.76-1.765-3.52-1.765-5.28s.588-3.52 1.765-5.28c1.176-1.76 2.82-3.295 4.464-4.59 1.644-1.3 3.29-2.36 4.934-3.18.035-.018.07-.036.106-.053 1.643-.82 3.29-1.3 4.933-1.467.036-.002.07-.003.106-.003s.07.001.106.003c1.644.166 3.29.646 4.934 1.467.035.017.07.035.106.053 1.643.82 3.29 1.88 4.933 3.18 1.643 1.295 3.288 2.83 4.464 4.59 1.177 1.76.588 3.52.588 5.28s-.588 3.52-1.765 5.28zM20.5 35.26c-1.37-.137-2.74-.54-4.11-1.205-1.37-.665-2.74-1.595-4.11-2.79-1.37-1.19-2.495-2.6-3.38-4.07-1.77-2.945-1.77-6.42 0-9.365.885-1.47 2.01-2.88 3.38-4.07 1.37-1.195 2.74-2.125 4.11-2.79 1.37-.665 2.74-1.07 4.11-1.205 2.945-.27 5.89.815 7.99 2.915 2.1 2.1 3.185 5.045 2.915 7.99-.135 1.37-.54 2.74-1.205 4.11-.665 1.37-1.595 2.74-2.79 4.11-1.19 1.37-2.6 2.495-4.07 3.38-1.47.885-2.88 1.53-4.245 1.935a8.216 8.216 0 0 1-1.765.175z"></path></svg>
                </div>
                <h1 class="welcome-title">What can I help with?</h1>
            </div>
            <div class="messages-wrapper" id="messagesWrapper"></div>
        </div>
        <div class="input-area">
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea class="message-input" id="messageInput" placeholder="Ask anything..." rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize()"></textarea>
                    <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>
                        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentConversationId = null;
        let conversations = {};
        let isLoading = false;
        let currentStreamingController = null;
        
        const config = {
            apiUrl: 'https://srv886023.hstgr.cloud/api/v1/prediction/b02cce0c-77a8-4b4f-8a4a-0de7afd15fc2'
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadConversations();
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);
            renderConversation();
            
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                autoResize();
                const sendButton = document.getElementById('sendButton');
                sendButton.disabled = messageInput.value.trim() === '' || isLoading;
            });
        });

        // Gestion des th√®mes
        function setTheme(theme) { 
            document.body.setAttribute('data-theme', theme); 
            localStorage.setItem('theme', theme); 
            document.querySelector('.theme-toggle').textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è'; 
        }
        
        function toggleTheme() { 
            const currentTheme = document.body.getAttribute('data-theme');
            setTheme(currentTheme === 'light' ? 'dark' : 'light'); 
        }
        
        function toggleSidebar() { 
            document.getElementById('sidebar').classList.toggle('open'); 
        }
        
        // Gestion des conversations
        function loadConversations() { 
            try {
                conversations = JSON.parse(localStorage.getItem('chat-conversations') || '{}'); 
            } catch (e) {
                conversations = {};
            }
            updateConversationsList(); 
        }
        
        function saveConversations() { 
            try {
                localStorage.setItem('chat-conversations', JSON.stringify(conversations)); 
            } catch (e) {
                console.error('Erreur sauvegarde conversations:', e);
            }
        }
        
        function startNewChat() {
            if (currentStreamingController) {
                currentStreamingController.abort();
                currentStreamingController = null;
            }
            
            currentConversationId = 'chat_' + Date.now();
            conversations[currentConversationId] = { 
                id: currentConversationId, 
                title: 'Nouvelle conversation', 
                messages: [], 
                createdAt: new Date().toISOString() 
            };
            renderConversation();
            updateConversationsList();
            saveConversations();
            document.getElementById('messageInput').focus();
        }
        
        function selectConversation(id) { 
            if (currentStreamingController) {
                currentStreamingController.abort();
                currentStreamingController = null;
            }
            currentConversationId = id; 
            renderConversation(); 
            updateConversationsList(); 
        }
        
        function deleteConversation(id, event) {
            event.stopPropagation();
            if (!confirm('Supprimer cette conversation ?')) return;
            
            if (currentConversationId === id && currentStreamingController) {
                currentStreamingController.abort();
                currentStreamingController = null;
            }
            
            delete conversations[id];
            if (currentConversationId === id) {
                currentConversationId = null;
            }
            renderConversation();
            updateConversationsList();
            saveConversations();
        }
        
        function updateConversationsList() {
            const container = document.getElementById('conversations');
            container.innerHTML = '';
            
            const conversationArray = Object.values(conversations);
            conversationArray.sort(function(a, b) {
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            conversationArray.forEach(function(conv) {
                const item = document.createElement('div');
                item.className = 'menu-item conversation-item';
                if (conv.id === currentConversationId) {
                    item.className += ' active';
                }
                
                item.onclick = function() { selectConversation(conv.id); };
                item.innerHTML = '<span>' + escapeHtml(conv.title) + '</span><button class="delete-btn" onclick="deleteConversation(\'' + conv.id + '\', event)">üóëÔ∏è</button>';
                container.appendChild(item);
            });
        }

        // Rendu des conversations
        function renderConversation() {
            const wrapper = document.getElementById('messagesWrapper');
            const welcomeScreen = document.getElementById('welcomeScreen');
            wrapper.innerHTML = '';
            
            if (currentConversationId && conversations[currentConversationId]) {
                welcomeScreen.style.display = 'none';
                const messages = conversations[currentConversationId].messages;
                messages.forEach(function(msg) {
                    addMessageToUI(msg.content, msg.isUser);
                });
            } else {
                welcomeScreen.style.display = 'flex';
            }
        }
        
        function addMessageToUI(content, isUser) {
            const wrapper = document.getElementById('messagesWrapper');
            const group = document.createElement('div');
            group.className = 'message-group';
            
            const avatarContent = isUser ? 'S' : '<svg viewBox="0 0 41 41"><path fill="currentColor" d="M37.532 19.2c-1.176 1.76-2.82 3.295-4.464 4.59-1.644 1.3-3.29 2.36-4.933 3.18-.035.018-.07.036-.106.053-1.644.82-3.29 1.3-4.933 1.467-.036.002-.07.003-.106.003-1.644-.165-3.29-.645-4.934-1.467-.035-.017-.07-.035-.106-.053-1.643-.82-3.29-1.88-4.933-3.18-1.643-1.295-3.288-2.83-4.464-4.59-1.177-1.76-1.765-3.52-1.765-5.28s.588-3.52 1.765-5.28c1.176-1.76 2.82-3.295 4.464-4.59 1.644-1.3 3.29-2.36 4.934-3.18.035-.018.07-.036.106-.053 1.643-.82 3.29-1.3 4.933-1.467.036-.002.07-.003.106-.003s.07.001.106.003c1.644.166 3.29.646 4.934 1.467.035.017.07.035.106.053 1.643.82 3.29 1.88 4.933 3.18 1.643 1.295 3.288 2.83 4.464 4.59 1.177 1.76.588 3.52.588 5.28s-.588 3.52-1.765 5.28zM20.5 35.26c-1.37-.137-2.74-.54-4.11-1.205-1.37-.665-2.74-1.595-4.11-2.79-1.37-1.19-2.495-2.6-3.38-4.07-1.77-2.945-1.77-6.42 0-9.365.885-1.47 2.01-2.88 3.38-4.07 1.37-1.195 2.74-2.125 4.11-2.79 1.37-.665 2.74-1.07 4.11-1.205 2.945-.27 5.89.815 7.99 2.915 2.1 2.1 3.185 5.045 2.915 7.99-.135 1.37-.54 2.74-1.205 4.11-.665 1.37-1.595 2.74-2.79 4.11-1.19 1.37-2.6 2.495-4.07 3.38-1.47.885-2.88 1.53-4.245 1.935a8.216 8.216 0 0 1-1.765.175z"></path></svg>';
            
            const messageContent = isUser ? '<p>' + escapeHtml(content) + '</p>' : content;
            
            group.innerHTML = '<div class="message ' + (isUser ? 'user-message' : 'bot-message') + '">' +
                '<div class="message-avatar ' + (isUser ? 'user-avatar' : 'bot-avatar') + '">' +
                avatarContent +
                '</div>' +
                '<div class="message-content">' + messageContent + '</div>' +
                '</div>';
                
            wrapper.appendChild(group);
            scrollToBottom();
            return group.querySelector('.message-content');
        }
        
        function saveMessage(content, isUser) {
            if (!currentConversationId) return;
            
            const conv = conversations[currentConversationId];
            conv.messages.push({ content: content, isUser: isUser });
            
            if (conv.messages.length === 1 && isUser) {
                conv.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                updateConversationsList();
            }
            saveConversations();
        }

        // Effet typewriter
        function typewriterEffect(element, text, speed) {
            if (!speed) speed = 30;
            
            return new Promise(function(resolve) {
                element.innerHTML = '';
                element.classList.add('streaming-message');
                
                const cursor = document.createElement('span');
                cursor.className = 'typing-cursor';
                element.appendChild(cursor);
                
                let i = 0;
                const timer = setInterval(function() {
                    if (i < text.length) {
                        const textNode = document.createTextNode(text.charAt(i));
                        element.insertBefore(textNode, cursor);
                        i++;
                        scrollToBottom();
                    } else {
                        clearInterval(timer);
                        cursor.remove();
                        element.classList.remove('streaming-message');
                        try {
                            element.innerHTML = marked.parse(text);
                        } catch (e) {
                            element.innerHTML = escapeHtml(text);
                        }
                        resolve();
                    }
                }, speed);
            });
        }

        // Envoi de message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message || isLoading) return;

            if (!currentConversationId) {
                startNewChat();
            }
            
            saveMessage(message, true);
            addMessageToUI(message, true);
            input.value = ''; 
            autoResize(); 
            setLoading(true);

            currentStreamingController = new AbortController();
            const botMessageElement = addMessageToUI('<span class="loading"></span>', false);
            let fullResponse = '';

            try {
                // Essayer d'abord avec streaming
                const response = await fetch(config.apiUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ "question": message }),
                    signal: currentStreamingController.signal
                });

                if (!response.ok) {
                    throw new Error('Erreur serveur: ' + response.status);
                }

                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('text/event-stream')) {
                    // Streaming d√©tect√©
                    console.log('Streaming d√©tect√©');
                    botMessageElement.innerHTML = '';
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    while (true) {
                        const result = await reader.read();
                        if (result.done) break;
                        
                        buffer += decoder.decode(result.value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';
                        
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i];
                            if (line.trim() === '') continue;
                            
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                
                                if (data === '[DONE]') {
                                    break;
                                }
                                
                                try {
                                    const parsed = JSON.parse(data);
                                    let token = '';
                                    
                                    if (parsed.token) {
                                        token = parsed.token;
                                    } else if (parsed.data && parsed.data.token) {
                                        token = parsed.data.token;
                                    } else if (parsed.chunk) {
                                        token = parsed.chunk;
                                    } else if (typeof parsed === 'string') {
                                        token = parsed;
                                    }
                                    
                                    if (token) {
                                        fullResponse += token;
                                        botMessageElement.innerHTML = escapeHtml(fullResponse) + '<span class="typing-cursor"></span>';
                                        scrollToBottom();
                                    }
                                } catch (e) {
                                    console.warn('Erreur parsing SSE:', e);
                                }
                            }
                        }
                    }
                    
                    const cursor = botMessageElement.querySelector('.typing-cursor');
                    if (cursor) cursor.remove();
                    
                    try {
                        botMessageElement.innerHTML = marked.parse(fullResponse);
                    } catch (e) {
                        botMessageElement.innerHTML = escapeHtml(fullResponse);
                    }
                    
                } else {
                    // Pas de streaming - r√©ponse normale avec effet typewriter
                    console.log('Pas de streaming - utilisation normale');
                    
                    const result = await response.json();
                    fullResponse = result.text || result.data?.text || result.message || JSON.stringify(result);
                    
                    await typewriterEffect(botMessageElement, fullResponse, 50);
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Requ√™te annul√©e');
                    return;
                }
                
                console.error('Erreur:', error);
                fullResponse = '‚ùå Erreur: ' + error.message;
                botMessageElement.innerHTML = escapeHtml(fullResponse);
                
            } finally {
                if (fullResponse && !fullResponse.startsWith('‚ùå')) {
                    saveMessage(fullResponse, false);
                }
                setLoading(false);
                currentStreamingController = null;
            }
        }

        function setLoading(loading) {
            isLoading = loading;
            const sendButton = document.getElementById('sendButton');
            const messageInput = document.getElementById('messageInput');
            
            messageInput.disabled = loading;
            sendButton.disabled = loading || messageInput.value.trim() === '';
            
            if (loading) {
                sendButton.innerHTML = '<div class="loading"></div>';
            } else {
                sendButton.innerHTML = '<svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>';
                messageInput.focus();
            }
        }

        // Fonctions utilitaires
        function autoResize() { 
            const textarea = document.getElementById('messageInput'); 
            textarea.style.height = 'auto'; 
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px'; 
        }
        
        function scrollToBottom() { 
            const container = document.getElementById('chatContainer'); 
            container.scrollTop = container.scrollHeight; 
        }
        
        function handleKeyDown(event) { 
            if (event.key === 'Enter' && !event.shiftKey) { 
                event.preventDefault(); 
                sendMessage(); 
            } else if (event.key === 'Escape' && currentStreamingController) {
                currentStreamingController.abort();
                currentStreamingController = null;
                setLoading(false);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Gestion des √©v√©nements r√©seau
        window.addEventListener('online', function() {
            console.log('Connexion r√©tablie');
        });

        window.addEventListener('offline', function() {
            console.log('Connexion perdue');
            if (currentStreamingController) {
                currentStreamingController.abort();
                currentStreamingController = null;
                setLoading(false);
            }
        });
    </script>
</body>
</html>
